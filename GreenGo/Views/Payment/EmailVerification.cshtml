@{
    ViewBag.Title = "Email Verification";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body {
        background-color: #F5F5F5;
    }

    .verification-wrapper {
        min-height: calc(100vh - 60px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
    }

    .verification-container {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 450px;
        width: 100%;
        padding: 50px 40px;
        text-align: center;
    }

    .verification-icon {
        width: 80px;
        height: 80px;
        background-color: #E8F5E9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 25px;
        font-size: 40px;
    }

    .verification-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
    }

    .verification-description {
        font-size: 14px;
        color: #666;
        line-height: 1.6;
        margin-bottom: 35px;
    }

    .code-input-container {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 30px;
    }

    .code-input {
        width: 55px;
        height: 60px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        color: #333;
        background-color: #FAFAFA;
        transition: all 0.2s;
    }

    .code-input:focus {
        outline: none;
        border-color: #7CB342;
        background-color: #ffffff;
    }

    .code-input.filled {
        border-color: #7CB342;
        background-color: #F9FFF9;
    }

    .code-input.error {
        border-color: #f44336;
        background-color: #FFEBEE;
    }

    .error-message {
        color: #f44336;
        font-size: 13px;
        margin-bottom: 20px;
        display: none;
    }

    .error-message.show {
        display: block;
    }

    .verify-btn {
        background-color: #7CB342;
        color: white;
        border: none;
        padding: 14px 40px;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
        margin-bottom: 20px;
    }

    .verify-btn:hover {
        background-color: #689F38;
    }

    .verify-btn:disabled {
        background-color: #E0E0E0;
        cursor: not-allowed;
    }

    .resend-section {
        font-size: 14px;
        color: #666;
        margin-top: 25px;
    }

    .resend-link {
        color: #7CB342;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
    }

    .resend-link:hover {
        text-decoration: underline;
    }

    .resend-link.disabled {
        color: #999;
        cursor: not-allowed;
        pointer-events: none;
    }

    .timer {
        color: #999;
        font-size: 13px;
        margin-top: 10px;
    }

    /* Success Animation */
   
    }

    .checkmark-circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke: #7CB342;
        fill: none;
        animation: checkmark 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .checkmark-check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: checkmark 0.3s 0.8s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }


        .code-input {
            width: 50px;
            height: 55px;
            font-size: 22px;
        }

        .code-input-container {
            gap: 8px;
        }
    }
</style>

<div class="verification-wrapper">
    <div class="verification-container">
        <div class="verification-icon">
            ✉️
        </div>

        <h1 class="verification-title">Payment Verification</h1>

        <p class="verification-description">
            We've sent a 4-digit verification code to your email. Please enter it below to complete your payment.
        </p>

        <form id="verificationForm">
            <div class="code-input-container">
                <input type="text" class="code-input" maxlength="1" data-index="0" />
                <input type="text" class="code-input" maxlength="1" data-index="1" />
                <input type="text" class="code-input" maxlength="1" data-index="2" />
                <input type="text" class="code-input" maxlength="1" data-index="3" />
            </div>

            <div class="error-message" id="errorMessage">
                Invalid verification code. Please try again.
            </div>

            <button type="submit" class="verify-btn" id="verifyBtn">Verify</button>
        </form>

        <div class="resend-section">
            Didn't receive the code?
            <a href="#" class="resend-link" id="resendLink">Resend Code</a>
            <div class="timer" id="timer"></div>
        </div>
    </div>
</div>

<!-- Success Modal (hidden by default) -->
<div id="successModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 50px 40px; text-align: center; max-width: 400px; animation: slideIn 0.3s ease-out;">
        <div style="margin-bottom: 25px;">
            <svg width="80" height="80" viewBox="0 0 52 52">
                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
                <path class="checkmark-check" fill="none" stroke="#7CB342" stroke-width="3" d="M14 27l7.5 7.5L38 18" />
            </svg>
        </div>
        <h2 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 15px;">Payment Successful!</h2>
        <p style="font-size: 14px; color: #666; margin-bottom: 30px;">Your booking has been confirmed. Redirecting to home page...</p>
        <button onclick="window.location.href='@Url.Action("Index", "Home")'" style="background-color: #7CB342; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer;">
            Go Back to Home
        </button>
    </div>
</div>

<style>
   
</style>

@section scripts {
    <script>
    $(document).ready(function() {
        var inputs = $('.code-input');
        var resendTimer = 60;
        var timerInterval;

        // Auto-focus first input
        inputs.first().focus();

        // Handle input navigation
        inputs.on('input', function(e) {
            var $this = $(this);
            var index = parseInt($this.data('index'));
            var value = $this.val();

            // Only allow numbers
            $this.val(value.replace(/[^0-9]/g, ''));

            // Add filled class
            if ($this.val()) {
                $this.addClass('filled');
                $this.removeClass('error');

                // Move to next input
                if (index < 3 && $this.val()) {
                    inputs.eq(index + 1).focus();
                }
            } else {
                $this.removeClass('filled');
            }

            // Auto-submit when all filled
            var allFilled = true;
            inputs.each(function() {
                if (!$(this).val()) {
                    allFilled = false;
                }
            });

            if (allFilled) {
                $('#verifyBtn').prop('disabled', false);
            }
        });

        // Handle backspace
        inputs.on('keydown', function(e) {
            var $this = $(this);
            var index = parseInt($this.data('index'));

            if (e.keyCode === 8 && !$this.val() && index > 0) {
                inputs.eq(index - 1).focus();
            }
        });

        // Handle paste
        inputs.first().on('paste', function(e) {
            e.preventDefault();
            var pasteData = e.originalEvent.clipboardData.getData('text');
            var digits = pasteData.replace(/[^0-9]/g, '').slice(0, 4);

            for (var i = 0; i < digits.length; i++) {
                inputs.eq(i).val(digits[i]).addClass('filled');
            }

            if (digits.length === 4) {
                inputs.last().focus();
                $('#verifyBtn').prop('disabled', false);
            }
        });

        // Form submission
        $('#verificationForm').on('submit', function(e) {
            e.preventDefault();

            var code = '';
            inputs.each(function() {
                code += $(this).val();
            });

            if (code.length !== 4) {
                showError();
                return;
            }

            // Show loading state
            $('#verifyBtn').prop('disabled', true).text('Verifying...');

            // Verify code
            $.ajax({
                url: '@Url.Action("VerifyCode", "Payment")',
                type: 'POST',
                data: {
                    code: code,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showSuccess();
                    } else {
                        showError();
                        $('#verifyBtn').prop('disabled', false).text('Verify');
                    }
                },
                error: function() {
                    showError();
                    $('#verifyBtn').prop('disabled', false).text('Verify');
                }
            });
        });

        // Resend code
        $('#resendLink').on('click', function(e) {
            e.preventDefault();

            if ($(this).hasClass('disabled')) return;

            $.ajax({
                url: '@Url.Action("ResendCode", "Payment")',
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        alert('Verification code has been resent to your email.');
                        startResendTimer();
                    }
                },
                error: function() {
                    alert('Failed to resend code. Please try again.');
                }
            });
        });

        function showError() {
            $('#errorMessage').addClass('show');
            inputs.addClass('error').val('');
            inputs.first().focus();

            setTimeout(function() {
                $('#errorMessage').removeClass('show');
                inputs.removeClass('error');
            }, 3000);
        }

        function showSuccess() {
            $('#successModal').css('display', 'flex');

            // Redirect after 3 seconds
            setTimeout(function() {
                window.location.href = '@Url.Action("Index", "Home")';
            }, 3000);
        }

        function startResendTimer() {
            resendTimer = 60;
            $('#resendLink').addClass('disabled');
            $('#timer').text('Resend available in ' + resendTimer + 's');

            timerInterval = setInterval(function() {
                resendTimer--;
                $('#timer').text('Resend available in ' + resendTimer + 's');

                if (resendTimer <= 0) {
                    clearInterval(timerInterval);
                    $('#resendLink').removeClass('disabled');
                    $('#timer').text('');
                }
            }, 1000);
        }

        // Start timer on page load
        startResendTimer();
    });
    </script>
}